<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola Produk - Admin BenihKu</title>
    <link rel="stylesheet" href="../assets/css/base-style.css" />
    <link rel="stylesheet" href="../assets/css/cart-style.css" />
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 120px auto 40px;
            padding: 0 20px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .btn-add {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: none;
            cursor: pointer;
        }

        .btn-add:hover {
            background: #218838;
        }

        .table-responsive {
            overflow-x: auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .product-img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 6px;
            background: #f0f0f0;
        }

        .action-btn {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            border: none;
            margin-right: 5px;
        }

        .btn-edit {
            background: #ffc107;
            color: #000;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-modal {
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
        }
    </style>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
</head>

<body>
    <nav class="nav-wrap container">
        <a href="../index.html" class="brand"><img src="../assets/img/logo.jpeg" alt="BenihKu logo" />BenihKu Admin</a>
        <ul class="links">
            <li><a href="dashboard.html">Dashboard</a></li>
            <li><a href="products.html" class="active">Produk</a></li>
            <li><a href="orders.html">Pesanan</a></li>
            <li><a href="users.html">Pelanggan</a></li>
            <li class="auth-link"><a href="#" onclick="logout(); return false;" style="color: #dc3545;">Logout</a></li>
        </ul>
    </nav>

    <main class="admin-container">
        <div class="page-header">
            <h1>Kelola Produk</h1>
            <button class="btn-add" onclick="openAddModal()">
                <ion-icon name="add-circle-outline"></ion-icon> Tambah Produk
            </button>
        </div>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Gambar</th>
                        <th>Nama Produk</th>
                        <th>Kategori</th>
                        <th>Harga</th>
                        <th>Stok</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="productTableBody">
                    <tr>
                        <td colspan="6" style="text-align:center;">Memuat data...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Add Modal -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Tambah Produk Baru</h2><button class="close-modal" onclick="closeAddModal()">&times;</button>
            </div>
            <form id="addForm">
                <div class="form-group"><label>Nama Produk</label><input type="text" name="name" required></div>
                <div class="form-group"><label>Kategori</label>
                    <select name="category_id" required>
                        <option value="1">Benih Sayuran</option>
                        <option value="2">Benih Buah</option>
                        <option value="3">Pupuk</option>
                        <option value="4">Alat Pertanian</option>
                    </select>
                </div>
                <div class="form-group"><label>Harga (Rp)</label><input type="number" name="price" required></div>
                <div class="form-group"><label>Stok</label><input type="number" name="stock" required></div>
                <div class="form-group"><label>Deskripsi</label><textarea name="description" rows="3"></textarea></div>
                <div class="form-group"><label>Foto Produk</label><input type="file" name="image" accept="image/*">
                </div>
                <button type="submit" class="btn-add" style="width:100%;">Simpan Produk</button>
            </form>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <option value="4">Alat Pertanian</option>
            </select>
        </div>
        <div class="form-group"><label>Harga (Rp)</label><input type="number" id="edit_price" required></div>
        <div class="form-group"><label>Stok</label><input type="number" id="edit_stock" required></div>
        <div class="form-group"><label>Deskripsi</label><textarea id="edit_description" rows="4"></textarea>
        </div>
        <button type="submit" class="btn-add" style="width:100%;">Update Produk</button>
        </form>
    </div>
    </div>

    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/product-gallery.js"></script>
    <script>
        async function checkAdmin() { const user = await checkAuth(); if (!user || user.role !== 'admin') { window.location.href = '../index.html'; } }
        checkAdmin();

        let allProducts = [];

        async function loadProducts() {
            try {
                const response = await fetch('../api/products/read.php?is_active=1');
                const data = await response.json();
                const tbody = document.getElementById('productTableBody');
                tbody.innerHTML = '';
                if (data.success && data.data.length > 0) {
                    allProducts = data.data;
                    data.data.forEach(p => {
                        const imgSrc = p.gambar ? `../${p.gambar}` : 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="50" height="50"%3E%3Crect fill="%23ddd" width="50" height="50"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" dy=".3em" fill="%23999" font-size="12"%3ENo Img%3C/text%3E%3C/svg%3E';
                        tbody.innerHTML += `<tr><td><img src="${imgSrc}" class="product-img"></td><td>${p.nama}</td><td>${p.kategori || '-'}</td><td>Rp ${parseInt(p.harga_raw || p.harga).toLocaleString('id-ID')}</td><td>${p.stok}</td><td><button class="action-btn btn-edit" onclick="openEditModal('${p.id}')">Edit</button><button class="action-btn btn-delete" onclick="deleteProduct('${p.id}', '${encodeURIComponent(p.nama)}')">Hapus</button></td></tr>`;
                    });
                } else { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Belum ada produk.</td></tr>'; }
            } catch (error) { console.error(error); document.getElementById('productTableBody').innerHTML = '<tr><td colspan="6" style="text-align:center;color:red;">Error: ' + error.message + '</td></tr>'; }
        }

        function openAddModal() { document.getElementById('addModal').classList.add('show'); }
        function closeAddModal() { document.getElementById('addModal').classList.remove('show'); document.getElementById('addForm').reset(); }

        document.getElementById('addForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true; btn.textContent = 'Menyimpan...';
            try {
                const response = await fetch('../api/products/create.php', { method: 'POST', body: formData });
                const result = await response.json();
                if (result.success) { alert('Produk berhasil ditambahkan!'); closeAddModal(); loadProducts(); }
                else { alert('Gagal: ' + result.message); }
            } catch (error) { alert('Error: ' + error.message); }
            finally { btn.disabled = false; btn.textContent = 'Simpan Produk'; }
        });

        function openEditModal(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) { alert('Produk tidak ditemukan'); return; }
            document.getElementById('edit_id').value = product.id;
            document.getElementById('edit_name').value = product.nama;
            document.getElementById('edit_category').value = product.category_id || 1;
            document.getElementById('edit_price').value = product.harga_raw || product.harga;
            document.getElementById('edit_stock').value = product.stok;
            document.getElementById('edit_description').value = product.deskripsi || '';

            // Load gallery images
            loadProductGallery(product.id);

            document.getElementById('editModal').classList.add('show');
        }

        function closeEditModal() { document.getElementById('editModal').classList.remove('show'); }

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('product_id', document.getElementById('edit_id').value);
            formData.append('name', document.getElementById('edit_name').value);
            formData.append('category_id', document.getElementById('edit_category').value);
            formData.append('price', document.getElementById('edit_price').value);
            formData.append('stock', document.getElementById('edit_stock').value);
            formData.append('description', document.getElementById('edit_description').value);

            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true; btn.textContent = 'Menyimpan...';
            try {
                const response = await fetch('../api/products/update.php', { method: 'POST', body: formData });
                const result = await response.json();
                if (result.success) { alert('Produk berhasil diupdate!'); closeEditModal(); loadProducts(); }
                else { alert('Gagal: ' + result.message); }
            } catch (error) { alert('Error: ' + error.message); }
            finally { btn.disabled = false; btn.textContent = 'Update Produk'; }
        });

        async function deleteProduct(productId, productName) {
            const name = decodeURIComponent(productName);
            if (!confirm(`Yakin ingin menghapus "${name}"?`)) return;
            try {
                const response = await fetch(`../api/products/delete.php?product_id=${productId}`, { method: 'DELETE' });
                const result = await response.json();
                if (result.success) { alert('Produk berhasil dihapus!'); loadProducts(); }
                else { alert('Gagal: ' + result.message); }
            } catch (error) { alert('Error: ' + error.message); }
        }

        loadProducts();
    </script>
</body>

</html>